# Admin パスワード保護 セットアップガイド

## 概要

ATE9 の Admin 画面にパスワード保護機能を追加しました。
未認証のユーザーは `/admin/login` でログインする必要があります。

**現在の実装**: 3人の Admin ユーザーが共通のパスワードを使用します。

---

## 環境変数の設定

### `.env.local` に追加

```bash
ADMIN_PASSWORD="共通パスワードをここに設定"
```

**重要**:

- **3人の Admin ユーザーが共通で使用するパスワード**を設定してください
- パスワードは強力なものを設定してください
- `.env.local` は Git にコミットしないでください（`.gitignore` に含まれていることを確認）
- 本番環境では、ホスティングサービスの環境変数設定で `ADMIN_PASSWORD` を設定してください
- パスワードを変更する場合は、3人全員に共有してください

---

## 実装内容

### 作成されたファイル

1. **`app/(admin)/admin/login/page.tsx`**
   - ログインページ（Client Component）
   - パスワード入力フォーム
   - ATE9 のデザインに合わせたスタイリング

2. **`app/api/admin/auth/route.ts`**
   - 認証 API Route
   - POST: パスワード検証とセッション設定
   - DELETE: ログアウト処理

3. **`lib/admin/auth.ts`**
   - 認証チェック用ユーティリティ関数
   - `checkAdminAuth()`: 認証状態をチェック
   - `requireAdminAuth()`: 認証が必要なページで使用（未認証時はリダイレクト）

4. **`components/admin/lp/AdminLogoutButton.tsx`**
   - ログアウトボタンコンポーネント
   - AdminShell のサイドバーに配置

### 修正されたファイル

1. **`app/(admin)/admin/dashboard/page.tsx`**
   - 認証チェックを追加（`requireAdminAuth()`）

2. **`app/(admin)/admin/page.tsx`**
   - 認証チェックを追加（`requireAdminAuth()`）

3. **`components/admin/lp/AdminShell.tsx`**
   - ログアウトボタンをサイドバーに追加

---

## 動作フロー

### ログイン

1. ユーザーが `/admin/dashboard` にアクセス
2. 未認証の場合、`requireAdminAuth()` が `/admin/login` にリダイレクト
3. ログインページでパスワードを入力
4. `/api/admin/auth` に POST リクエスト
5. パスワードが正しい場合、`admin-authenticated` cookie を設定（24時間有効）
6. `/admin/dashboard` にリダイレクト

### ログアウト

1. サイドバーの「ログアウト」ボタンをクリック
2. `/api/admin/auth` に DELETE リクエスト
3. `admin-authenticated` cookie を削除
4. `/admin/login` にリダイレクト

### セッション管理

- **有効期限**: 24時間
- **Cookie 名**: `admin-authenticated`
- **設定**: `httpOnly: true`（JavaScript からアクセス不可）
- **セキュリティ**: 本番環境では `secure: true`（HTTPS のみ）
- **ユーザー管理**: 現在は3人の Admin ユーザーが共通パスワードを使用

---

## セキュリティ考慮事項

### ✅ 実装済み

- パスワードは環境変数で管理（コードに含まれない）
- Cookie は `httpOnly` で設定（XSS 攻撃対策）
- 本番環境では `secure` フラグを有効化（HTTPS のみ）
- パスワード検証はサーバー側で実行

### ⚠️ 注意事項

- 現在の実装は**シンプルなパスワード認証**です
- より高度なセキュリティが必要な場合は、以下を検討してください：
  - Supabase Auth の統合
  - NextAuth.js の使用
  - 2要素認証（2FA）
  - レート制限（ブルートフォース攻撃対策）

---

## トラブルシューティング

### パスワードが正しいのにログインできない

1. `.env.local` に `ADMIN_PASSWORD` が正しく設定されているか確認
2. サーバーを再起動（環境変数の変更を反映）
3. ブラウザの開発者ツールで Cookie を確認（`admin-authenticated` が設定されているか）

### ログイン後も `/admin/login` にリダイレクトされる

1. Cookie が正しく設定されているか確認
2. ブラウザの Cookie をクリアして再試行
3. サーバーログでエラーを確認

### 環境変数が読み込まれない

1. `.env.local` がプロジェクトルートに存在するか確認
2. ファイル名が正確か確認（`.env.local` であること）
3. Next.js を再起動

---

## テスト手順

1. **環境変数の設定**

   ```bash
   echo 'ADMIN_PASSWORD="test-password-123"' >> .env.local
   ```

2. **サーバーを再起動**

   ```bash
   npm run dev
   ```

3. **ログインテスト**
   - `/admin/dashboard` にアクセス → `/admin/login` にリダイレクトされることを確認
   - 間違ったパスワードを入力 → エラーメッセージが表示されることを確認
   - 正しいパスワードを入力 → `/admin/dashboard` にリダイレクトされることを確認

4. **ログアウトテスト**
   - ログイン後、サイドバーの「ログアウト」ボタンをクリック
   - `/admin/login` にリダイレクトされることを確認
   - 再度 `/admin/dashboard` にアクセス → `/admin/login` にリダイレクトされることを確認

5. **セッション有効期限のテスト**
   - ログイン後、24時間経過
   - `/admin/dashboard` にアクセス → `/admin/login` にリダイレクトされることを確認

---

## 今後の改善案

### オプション機能

1. **セッション延長機能**
   - アクティブな操作がある場合、セッションを自動延長

2. **ログイン履歴**
   - ログイン試行の記録
   - 失敗回数の制限

3. **パスワード変更機能**
   - 環境変数を変更せずにパスワードを変更できる機能

4. **個別ユーザー管理（将来的な拡張）**
   - 現在は3人で共通パスワードを使用
   - 将来的に各ユーザーに個別のパスワードを設定する場合は、以下を検討：
     - Supabase Auth の統合
     - ユーザー管理テーブルの作成
     - 個別の認証情報管理

---

## まとめ

Admin 画面にパスワード保護機能を追加しました。

**現在の仕様**:

- **3人の Admin ユーザーが共通パスワードを使用**
- 各ユーザーは同じ `ADMIN_PASSWORD` でログイン可能
- セッションは各ユーザーのブラウザで個別に管理（24時間有効）

**必須の設定**:

- `.env.local` に `ADMIN_PASSWORD` を設定（3人で共有するパスワード）

**動作確認**:

- `/admin/dashboard` にアクセス → ログインページにリダイレクト
- 正しいパスワードでログイン → ダッシュボードにアクセス可能
- ログアウト → 再度ログインが必要
- 3人それぞれが同じパスワードでログイン可能であることを確認
